package services

import (
	"bytes"
	"fmt"
	"perjalanan-dinas/backend/internal/models"
	"time"

	"github.com/jung-kurt/gofpdf"
)

type PDFGenerator struct{}

func NewPDFGenerator() *PDFGenerator {
	return &PDFGenerator{}
}

// GenerateNotaPermintaan generates Nota Permintaan Surat Tugas Perjalanan Dinas (Page 1)
func (pg *PDFGenerator) GenerateNotaPermintaan(request *models.TravelRequest) ([]byte, error) {
	pdf := gofpdf.New("P", "mm", "A4", "")
	pdf.AddPage()

	// Set font
	pdf.SetFont("Arial", "B", 14)

	// Title
	pdf.CellFormat(0, 10, "NOTA PERMINTAAN SURAT TUGAS PERJALANAN DINAS", "", 1, "C", false, 0, "")
	pdf.Ln(5)

	// Nomor
	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(50, 7, "Nomor", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.RequestNumber, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	// Data Karyawan
	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Data Karyawan:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "NIP", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.NIP, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Nama", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Name, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Jabatan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Position, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	// Detail Perjalanan Dinas
	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Detail Perjalanan Dinas:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "Maksud Perjalanan Dinas", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.MultiCell(0, 7, request.Purpose, "", "L", false)

	pdf.CellFormat(50, 7, "Tempat Berangkat", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.DeparturePlace, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Tempat Tujuan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Destination, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Tanggal Berangkat", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.DepartureDate.Format("02 January 2006"), "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Tanggal Kembali", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.ReturnDate.Format("02 January 2006"), "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Lama Perjalanan Dinas", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, fmt.Sprintf("%d hari", request.DurationDays), "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Angkutan yang Digunakan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Transportation, "", 1, "L", false, 0, "")
	pdf.Ln(10)

	// Footer - Tanggal dibuat
	pdf.CellFormat(0, 7, "Surabaya, "+time.Now().Format("02 January 2006"), "", 1, "R", false, 0, "")
	pdf.Ln(15)
	pdf.CellFormat(0, 7, "Pemohon,", "", 1, "R", false, 0, "")
	pdf.Ln(15)
	pdf.CellFormat(0, 7, "("+request.Employee.Name+")", "", 1, "R", false, 0, "")

	var buf bytes.Buffer
	err := pdf.Output(&buf)
	if err != nil {
		return nil, err
	}
	return buf.Bytes(), nil
}

// GenerateBeritaAcara generates Berita Acara Perjalanan Dinas (Page 2)
func (pg *PDFGenerator) GenerateBeritaAcara(request *models.TravelRequest, report *models.TravelReport) ([]byte, error) {
	pdf := gofpdf.New("P", "mm", "A4", "")
	pdf.AddPage()

	// Set font
	pdf.SetFont("Arial", "B", 14)

	// Title
	pdf.CellFormat(0, 10, "BERITA ACARA PERJALANAN DINAS", "", 1, "C", false, 0, "")
	pdf.Ln(5)

	// Nomor
	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(50, 7, "Nomor", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, report.ReportNumber, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	// Data Karyawan
	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Data Karyawan:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "NIP", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.NIP, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Nama", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Name, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Jabatan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Position, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	// Detail Perjalanan
	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Detail Perjalanan Dinas:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "Maksud Perjalanan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.MultiCell(0, 7, request.Purpose, "", "L", false)

	pdf.CellFormat(50, 7, "Tempat Tujuan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Destination, "", 1, "L", false, 0, "")
	pdf.Ln(5)

	// Tabel Bukti Kunjungan
	pdf.SetFont("Arial", "B", 10)
	pdf.CellFormat(0, 7, "Bukti Kunjungan:", "", 1, "L", false, 0, "")
	pdf.Ln(2)

	// Table headers
	pdf.SetFont("Arial", "B", 9)
	pdf.CellFormat(25, 10, "Tanggal", "1", 0, "C", false, 0, "")
	pdf.CellFormat(30, 10, "Berangkat Dari", "1", 0, "C", false, 0, "")
	pdf.CellFormat(35, 10, "Bermalam/Singgah", "1", 0, "C", false, 0, "")
	pdf.CellFormat(30, 10, "Datang Di", "1", 0, "C", false, 0, "")
	pdf.CellFormat(70, 10, "Tanda Tangan KP/Cabang/Lembaga", "1", 1, "C", false, 0, "")

	// Table data
	pdf.SetFont("Arial", "", 8)
	for _, proof := range report.VisitProofs {
		pdf.CellFormat(25, 10, proof.Date.Format("02/01/2006"), "1", 0, "C", false, 0, "")
		pdf.CellFormat(30, 10, proof.DepartFrom, "1", 0, "L", false, 0, "")
		pdf.CellFormat(35, 10, proof.StayOrStopAt, "1", 0, "L", false, 0, "")
		pdf.CellFormat(30, 10, proof.ArriveAt, "1", 0, "L", false, 0, "")
		pdf.CellFormat(70, 10, proof.SignatureProof, "1", 1, "C", false, 0, "")
	}
	pdf.Ln(10)

	// Signature section
	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(0, 7, "Surabaya, "+time.Now().Format("02 January 2006"), "", 1, "R", false, 0, "")
	pdf.Ln(5)
	pdf.CellFormat(0, 7, "Perwakilan Karyawan,", "", 1, "R", false, 0, "")
	pdf.Ln(15)
	pdf.CellFormat(0, 7, "("+report.RepresentativeName+")", "", 1, "R", false, 0, "")
	pdf.CellFormat(0, 7, report.RepresentativePosition, "", 1, "R", false, 0, "")

	var buf bytes.Buffer
	err := pdf.Output(&buf)
	if err != nil {
		return nil, err
	}
	return buf.Bytes(), nil
}

// GenerateCombinedPDF generates both documents in one PDF
func (pg *PDFGenerator) GenerateCombinedPDF(request *models.TravelRequest, report *models.TravelReport) ([]byte, error) {
	pdf := gofpdf.New("P", "mm", "A4", "")

	// Page 1: Nota Permintaan
	pdf.AddPage()
	pdf.SetFont("Arial", "B", 14)
	pdf.CellFormat(0, 10, "NOTA PERMINTAAN SURAT TUGAS PERJALANAN DINAS", "", 1, "C", false, 0, "")
	pdf.Ln(5)

	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(50, 7, "Nomor", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.RequestNumber, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Data Karyawan:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "NIP", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.NIP, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Nama", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Name, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Jabatan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Position, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Detail Perjalanan Dinas:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "Maksud Perjalanan Dinas", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.MultiCell(0, 7, request.Purpose, "", "L", false)

	pdf.CellFormat(50, 7, "Tempat Berangkat", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.DeparturePlace, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Tempat Tujuan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Destination, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Tanggal Berangkat", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.DepartureDate.Format("02 January 2006"), "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Tanggal Kembali", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.ReturnDate.Format("02 January 2006"), "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Lama Perjalanan Dinas", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, fmt.Sprintf("%d hari", request.DurationDays), "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Angkutan yang Digunakan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Transportation, "", 1, "L", false, 0, "")
	pdf.Ln(10)

	pdf.CellFormat(0, 7, "Surabaya, "+time.Now().Format("02 January 2006"), "", 1, "R", false, 0, "")
	pdf.Ln(15)
	pdf.CellFormat(0, 7, "Pemohon,", "", 1, "R", false, 0, "")
	pdf.Ln(15)
	pdf.CellFormat(0, 7, "("+request.Employee.Name+")", "", 1, "R", false, 0, "")

	// Page 2: Berita Acara
	pdf.AddPage()
	pdf.SetFont("Arial", "B", 14)
	pdf.CellFormat(0, 10, "BERITA ACARA PERJALANAN DINAS", "", 1, "C", false, 0, "")
	pdf.Ln(5)

	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(50, 7, "Nomor", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, report.ReportNumber, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Data Karyawan:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "NIP", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.NIP, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Nama", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Name, "", 1, "L", false, 0, "")

	pdf.CellFormat(50, 7, "Jabatan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Employee.Position, "", 1, "L", false, 0, "")
	pdf.Ln(3)

	pdf.SetFont("Arial", "B", 11)
	pdf.CellFormat(0, 7, "Detail Perjalanan Dinas:", "", 1, "L", false, 0, "")
	pdf.SetFont("Arial", "", 11)

	pdf.CellFormat(50, 7, "Maksud Perjalanan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.MultiCell(0, 7, request.Purpose, "", "L", false)

	pdf.CellFormat(50, 7, "Tempat Tujuan", "", 0, "L", false, 0, "")
	pdf.CellFormat(5, 7, ":", "", 0, "L", false, 0, "")
	pdf.CellFormat(0, 7, request.Destination, "", 1, "L", false, 0, "")
	pdf.Ln(5)

	pdf.SetFont("Arial", "B", 10)
	pdf.CellFormat(0, 7, "Bukti Kunjungan:", "", 1, "L", false, 0, "")
	pdf.Ln(2)

	pdf.SetFont("Arial", "B", 9)
	pdf.CellFormat(25, 10, "Tanggal", "1", 0, "C", false, 0, "")
	pdf.CellFormat(30, 10, "Berangkat Dari", "1", 0, "C", false, 0, "")
	pdf.CellFormat(35, 10, "Bermalam/Singgah", "1", 0, "C", false, 0, "")
	pdf.CellFormat(30, 10, "Datang Di", "1", 0, "C", false, 0, "")
	pdf.CellFormat(70, 10, "Tanda Tangan KP/Cabang/Lembaga", "1", 1, "C", false, 0, "")

	pdf.SetFont("Arial", "", 8)
	for _, proof := range report.VisitProofs {
		pdf.CellFormat(25, 10, proof.Date.Format("02/01/2006"), "1", 0, "C", false, 0, "")
		pdf.CellFormat(30, 10, proof.DepartFrom, "1", 0, "L", false, 0, "")
		pdf.CellFormat(35, 10, proof.StayOrStopAt, "1", 0, "L", false, 0, "")
		pdf.CellFormat(30, 10, proof.ArriveAt, "1", 0, "L", false, 0, "")
		pdf.CellFormat(70, 10, proof.SignatureProof, "1", 1, "C", false, 0, "")
	}
	pdf.Ln(10)

	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(0, 7, "Surabaya, "+time.Now().Format("02 January 2006"), "", 1, "R", false, 0, "")
	pdf.Ln(5)
	pdf.CellFormat(0, 7, "Perwakilan Karyawan,", "", 1, "R", false, 0, "")
	pdf.Ln(15)
	pdf.CellFormat(0, 7, "("+report.RepresentativeName+")", "", 1, "R", false, 0, "")
	pdf.CellFormat(0, 7, report.RepresentativePosition, "", 1, "R", false, 0, "")

	var buf bytes.Buffer
	err := pdf.Output(&buf)
	if err != nil {
		return nil, err
	}
	return buf.Bytes(), nil
}
